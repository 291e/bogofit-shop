# 📁 Scripts 폴더

이 폴더에는 BogoFit 데이터베이스 관리를 위한 유틸리티 스크립트들이 포함되어 있습니다.

## 🚀 사용 방법

모든 스크립트는 프로젝트 루트 디렉토리에서 실행해야 합니다:

```bash
# TypeScript로 직접 실행
npx tsx scripts/[스크립트명].ts

# 또는 Node.js로 컴파일 후 실행
npx tsc scripts/[스크립트명].ts && node scripts/[스크립트명].js
```

## 📝 스크립트 목록

### 1. 🏪 상품 이름 업데이트 (`update-store-name.ts`)

- **목적**: 모든 상품의 `storeName`을 특정 값으로 일괄 변경
- **사용법**: `npx tsx scripts/update-store-name.ts`
- **기능**:
  - 현재 storeName 현황 조회
  - 사용자 확인 후 일괄 업데이트
  - 진행률 표시 및 결과 요약

### 2. 🧹 중복 상품 제거 (`remove-duplicate-products.ts`)

- **목적**: 동일한 상품명을 가진 중복 상품 정리
- **사용법**: `npx tsx scripts/remove-duplicate-products.ts`
- **기능**:
  - 중복 상품 감지 및 분석
  - 관련 데이터(리뷰, 주문) 보존 여부 확인
  - 안전한 중복 제거 실행

### 3. 💰 상품 가격 인상 (`increase-product-prices.ts`)

- **목적**: 모든 상품의 가격을 일정 비율로 일괄 인상
- **사용법**: `npx tsx scripts/increase-product-prices.ts`
- **기능**:
  - 현재 가격 현황 및 통계 조회
  - 가격 인상 미리보기 (상위 10개 상품)
  - 10% 가격 인상 실행 (기본값, 코드에서 수정 가능)
  - **100원 단위 자동 반올림** (끝자리 00으로 통일)
  - 0원 상품 자동 제외
  - 100원 미만 상품은 최소 100원으로 설정
  - 배치 처리로 안전한 업데이트
  - 실시간 진행률 표시

### 4. ↩️ 상품 가격 되돌리기 (`rollback-price-increase.ts`)

- **목적**: 가격 인상을 되돌려 원래 가격으로 복구
- **사용법**: `npx tsx scripts/rollback-price-increase.ts`
- **기능**:
  - 10% 인상을 되돌림 (현재 가격 ÷ 1.1)
  - 가격 되돌리기 미리보기 (상위 10개 상품)
  - **100원 단위 자동 반올림** (끝자리 00으로 통일)
  - 0원 상품 자동 제외
  - 되돌린 후 100원 미만이 될 상품은 최소 100원으로 설정
  - 배치 처리로 안전한 업데이트
  - 실시간 진행률 표시

## ⚙️ 설정 옵션

### 가격 인상 스크립트 (`increase-product-prices.ts`)

스크립트 상단에서 다음 값들을 수정할 수 있습니다:

```typescript
// 가격 인상률 (기본 10%)
const PRICE_INCREASE_RATE = 0.1; // 0.1 = 10%, 0.2 = 20%

// 배치 처리 크기 (한 번에 처리할 상품 수)
const BATCH_SIZE = 100;

// 최소 가격 (100원)
const MIN_PRICE = 100;
```

#### 가격 계산 규칙

1. **기존 가격 × (1 + 인상률)** 계산
2. **100원 단위로 반올림** (끝자리 00으로 변경)
3. **최소 100원 보장**

**예시:**

- 1,234원 → 1,357.4원 → **1,400원** (100원 단위 반올림)
- 50원 → 55원 → **100원** (최소 가격 보장)
- 1,950원 → 2,145원 → **2,100원** (100원 단위 반올림)
- 9,999원 → 10,998.9원 → **11,000원** (100원 단위 반올림)

## 🔄 가격 인상 → 되돌리기 워크플로우

### 권장 실행 순서

1. **🔍 먼저 가격 현황을 확인하세요:**

   ```bash
   npm run script:increase-prices
   # 미리보기까지만 확인하고 'no'로 취소
   ```

2. **📈 가격 인상 실행:**

   ```bash
   npm run script:increase-prices
   # 'yes'로 실행
   ```

3. **↩️ 가격 되돌리기 (필요한 경우):**

   ```bash
   npm run script:rollback-prices
   # 'yes'로 실행
   ```

4. **🔄 다시 인상 (필요한 경우):**
   ```bash
   npm run script:increase-prices
   # 'yes'로 실행
   ```

### ⚠️ 중요 주의사항

- **가격 되돌리기는 가장 최근의 10% 인상만 되돌립니다**
- **여러 번 인상한 경우, 한 번만 되돌려집니다**
- **되돌리기 후 다시 인상하면 원래 의도한 결과를 얻을 수 있습니다**

## 🔒 안전 기능

### 1. 사용자 확인

- 모든 스크립트는 실제 실행 전 사용자 확인을 요구합니다
- `yes`를 정확히 입력해야 실행됩니다

### 2. 미리보기

- 실제 변경 전에 예상 결과를 미리 보여줍니다
- 영향받을 데이터의 범위를 명확히 표시합니다

### 3. 배치 처리

- 대량의 데이터를 안전하게 처리하기 위해 배치 단위로 실행
- 메모리 사용량 최적화 및 데이터베이스 부하 분산

### 4. 에러 처리

- 개별 레코드 처리 실패 시에도 전체 작업 계속 진행
- 상세한 에러 로그 및 성공/실패 통계 제공

## ⚠️ 주의사항

### 1. 백업 필수

```bash
# 스크립트 실행 전 반드시 데이터베이스 백업
pg_dump your_database > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. 환경 확인

- **Production 환경에서는 절대 직접 실행하지 마세요**
- **Staging 환경에서 충분히 테스트 후 사용하세요**
- `.env` 파일의 `DATABASE_URL`을 확인하세요

### 3. 권한 확인

- 데이터베이스 읽기/쓰기 권한이 필요합니다
- 테이블별 UPDATE 권한을 확인하세요

## 📊 실행 예시

### 가격 인상 스크립트 실행 결과:

```bash
$ npm run script:increase-prices

🏪 BogoFit 상품 가격 일괄 인상 스크립트
==================================================
📈 인상률: 10%

🔍 현재 상품 가격 현황 조회 중...
📊 전체 상품 수: 1,234개
💰 평균 가격: 45,000원
📈 최고 가격: 299,000원
📉 최저 가격: 5,000원

📊 가격대별 상품 분포:
  💵 100원 미만: 5개
  💵 100원 이상 1만원 미만: 118개
  💵 1만원 이상 5만원 미만: 567개
  💵 5만원 이상 10만원 미만: 345개
  💵 10만원 이상 50만원 미만: 199개

🔍 가격 인상 미리보기 (상위 10개 상품):
┌─────────────────────────────────────┬──────────────┬──────────────┬──────────────┐
│ 상품명                             │   현재 가격  │   인상 가격  │   인상 금액  │
├─────────────────────────────────────┼──────────────┼──────────────┼──────────────┤
│ 프리미엄 다운 재킷                 │    299,000원 │    329,000원 │     30,000원 │
│ 울트라 부스트 러닝화               │    189,000원 │    208,000원 │     19,000원 │
└─────────────────────────────────────┴──────────────┴──────────────┴──────────────┘

⚠️  1,234개 상품의 가격을 10% 인상합니다.
💡 0원 상품 0개는 제외됩니다.
💡 100원 미만 상품 5개는 최소 100원으로 설정됩니다.
🔢 모든 가격은 100원 단위로 반올림됩니다. (끝자리 00)

정말 실행하시겠습니까? 이 작업은 되돌릴 수 없습니다. (yes/no): yes

🚀 가격 인상 시작 (1,234개 상품)...
📈 진행률: 100% (1,234/1,234) | 성공: 1,234개 | 실패: 0개

============================================================
📊 가격 인상 완료 요약
============================================================
✅ 처리된 상품: 1,234개
🎯 성공적으로 인상: 1,234개

💰 업데이트 후 평균 가격: 49,500원
📈 업데이트 후 최고 가격: 329,000원
📉 업데이트 후 최저 가격: 5,500원

🎉 가격 인상이 완료되었습니다!
```

### 가격 되돌리기 스크립트 실행 결과:

```bash
$ npm run script:rollback-prices

↩️  BogoFit 상품 가격 되돌리기 스크립트
==================================================
📉 되돌릴 인상률: 10%
💡 10% 인상을 되돌려 원래 가격으로 복구합니다.

🔍 현재 상품 가격 현황 조회 중...
📊 전체 상품 수: 1,234개
💰 현재 평균 가격: 49,500원
📈 현재 최고 가격: 329,000원
📉 현재 최저 가격: 5,500원

🔍 가격 되돌리기 미리보기 (상위 10개 상품):
┌─────────────────────────────────────┬──────────────┬──────────────┬──────────────┐
│ 상품명                             │   현재 가격  │   되돌린 가격│   감소 금액  │
├─────────────────────────────────────┼──────────────┼──────────────┼──────────────┤
│ 프리미엄 다운 재킷                 │    329,000원 │    299,100원 │     29,900원 │
│ 울트라 부스트 러닝화               │    208,000원 │    189,100원 │     18,900원 │
└─────────────────────────────────────┴──────────────┴──────────────┴──────────────┘

⚠️  1,234개 상품의 가격을 10% 인상 이전으로 되돌립니다.
💡 0원 상품 0개는 제외됩니다.
💡 되돌린 후 100원 미만이 될 상품 3개는 최소 100원으로 설정됩니다.
🔢 모든 가격은 100원 단위로 반올림됩니다. (끝자리 00)

정말 실행하시겠습니까? 이 작업은 되돌릴 수 없습니다. (yes/no): yes

🚀 가격 되돌리기 시작 (1,234개 상품)...
📈 진행률: 100% (1,234/1,234) | 성공: 1,234개 | 실패: 0개

============================================================
📊 가격 되돌리기 완료 요약
============================================================
✅ 처리된 상품: 1,234개
🎯 성공적으로 되돌림: 1,234개

💰 되돌린 후 평균 가격: 45,000원
📈 되돌린 후 최고 가격: 299,100원
📉 되돌린 후 최저 가격: 5,000원

🎉 가격 되돌리기가 완료되었습니다!
💡 이제 다시 가격 인상 스크립트를 실행할 수 있습니다.
```

## 🛠️ 문제 해결

### 1. 권한 오류

```bash
Error: permission denied for table product
```

**해결**: 데이터베이스 사용자에게 해당 테이블의 UPDATE 권한을 부여하세요.

### 2. 연결 오류

```bash
Error: connect ECONNREFUSED
```

**해결**:

- `.env` 파일의 `DATABASE_URL` 확인
- 데이터베이스 서버 실행 상태 확인
- 네트워크 연결 확인

### 3. 메모리 부족

```bash
Error: JavaScript heap out of memory
```

**해결**:

- `BATCH_SIZE` 값을 더 작게 설정 (예: 50)
- Node.js 메모리 제한 증가: `node --max-old-space-size=4096`

## 📞 지원

문제가 발생하거나 새로운 스크립트가 필요한 경우:

1. 개발팀에 문의하세요
2. GitHub Issues에 등록하세요
3. 로그 파일과 함께 오류 내용을 공유해주세요
