"use client";

import { useState, useEffect, useMemo } from "react";
import { Button } from "@/components/ui/button";
import { ProductResponseDto } from "@/types/product";
// import { useBrandContext } from "@/app/business/brands/[id]/layout"; // Unused
import { useProducts } from "@/hooks/useProducts";
import { useQueryClient } from "@tanstack/react-query";
import { PRODUCTS_QUERY_KEY, PRODUCT_DETAIL_QUERY_KEY } from "@/hooks/useProducts";
import { useDebounce } from "@/hooks/useDebounce";
import Image from "next/image";
import { useRouter } from "next/navigation";
import { Input } from "@/components/ui/input";
import { Search } from "lucide-react";
import { Switch } from "@/components/ui/switch";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { useAuth } from "@/providers/authProvider";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import ProductDeleteConfirmModal from "./ProductForm/ProductDeleteConfirmModal";

interface AllProductsSubSectionProps {
  brandId?: string;
}

export default function AllProductsSubSection({ 
  brandId 
}: AllProductsSubSectionProps) {
  const router = useRouter();
  const { getToken } = useAuth();
  const [pageNumber, setPageNumber] = useState(1);
  const [searchTerm, setSearchTerm] = useState("");
  const [togglingProducts, setTogglingProducts] = useState<Set<string>>(new Set());
  const [deletingProducts, setDeletingProducts] = useState<Set<string>>(new Set());
  const [selectedProduct, setSelectedProduct] = useState<ProductResponseDto | null>(null);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [productToDelete, setProductToDelete] = useState<ProductResponseDto | null>(null);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  
  // Debounce search term to avoid spamming API
  const debouncedSearchTerm = useDebounce(searchTerm, 500);
  
  // Reset to page 1 when search term changes
  useEffect(() => {
    if (debouncedSearchTerm) {
      setPageNumber(1);
    }
  }, [debouncedSearchTerm]);
  
  // ‚úÖ Use React Query for products with backend search
  const { data, isLoading, error } = useProducts(brandId, pageNumber, debouncedSearchTerm);
  
  // ‚úÖ Use query client for cache invalidation
  const queryClient = useQueryClient();
  
  // Extract products and pagination from response
  const products: ProductResponseDto[] = useMemo(() => {
    return Array.isArray(data?.data?.data) 
      ? data.data.data 
      : Array.isArray(data?.data) 
        ? data.data 
        : Array.isArray(data?.products) 
          ? data.products 
          : [];
  }, [data]);

  // ‚úÖ Debug: Log first product to see data structure
  useEffect(() => {
    if (products.length > 0) {
      console.log('üîç First product data:', products[0]);
      console.log('üîç Product status:', products[0].status);
      console.log('üîç Product isActive:', products[0].isActive);
    }
  }, [products]);
  
  // Pagination is inside data.data, NOT data.pagination
  const totalPages = data?.data?.totalPages || data?.pagination?.totalPages || data?.totalPages || 1;
  const totalProducts = data?.data?.totalCount || data?.pagination?.totalCount || products.length;
  const currentPage = data?.data?.page || data?.pagination?.currentPage || pageNumber;
  
  // Debug logging
  console.log('üîç AllProducts - pageNumber:', pageNumber, 'brandId:', brandId);
  console.log('üìä AllProducts - Pagination:', { 
    totalPages, 
    totalProducts, 
    currentPage,
    productsCount: products.length 
  });

  // No need for client-side filtering anymore - backend handles search
  const filteredProducts = products;

  const handleViewProduct = (product: ProductResponseDto) => {
    setSelectedProduct(product);
    setShowDetailModal(true);
  };

  const handleEditProduct = (product: ProductResponseDto) => {
    // Navigate to edit page with product ID
    router.push(`/business/brands/${brandId}/products/${product.id}/edit`);
  };

  const handleRegisterClick = () => {
    router.push(`/business/brands/${brandId}/products/register`);
  };

  // ‚úÖ Handle toggle isActive using custom mutation
  const handleToggleActive = async (productId: string, isActive: boolean) => {
    // Add to toggling set for loading state
    setTogglingProducts(prev => new Set(prev).add(productId));
    
    try {
      const token = getToken();
      if (!token) {
        toast.error('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
        return;
      }

      // ‚úÖ Use the same logic as useUpdateProduct hook
      const response = await fetch(`/api/product/${productId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({ isActive }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ 
          success: false, 
          message: 'Unknown error' 
        }));
        
        // ‚úÖ Debug: Log error response from backend
        console.log('üîç Product Update Error Response:', {
          status: response.status,
          statusText: response.statusText,
          success: errorData.success,
          message: errorData.message,
          errorType: errorData.errorType,
          fullErrorData: errorData
        });
        
        // ‚úÖ Check backend response format first
        if (errorData.success === false && errorData.message) {
          // Backend returned proper error format
          toast.error(errorData.message);
          return;
        }
        
        // ‚úÖ Fallback to status code based errors
        if (response.status === 401) {
          toast.error('Invalid token - Please login again');
          return;
        }
        if (response.status === 403) {
          toast.error('Access denied - Contact administrator');
          return;
        }
        if (response.status === 404) {
          toast.error('Product not found');
          return;
        }
        if (response.status === 500) {
          toast.error('Server error - Please try again later');
          return;
        }
        
        // ‚úÖ Generic error with backend message
        const errorMessage = errorData.message || `HTTP ${response.status}: ${response.statusText}`;
        toast.error(`Product status update failed: ${errorMessage}`);
        return;
      }

      const responseData = await response.json();
      
      // ‚úÖ Debug: Log actual response from backend
      console.log('üîç Product Update Response:', {
        success: responseData.success,
        message: responseData.message,
        data: responseData.data,
        fullResponse: responseData
      });
      
      // ‚úÖ Check backend response format
      if (!responseData.success) {
        toast.error(responseData.message || 'Product status update failed');
        return;
      }
      
      // ‚úÖ Use the same cache update logic as useUpdateProduct
      if (responseData.success && responseData.data) {
        // ‚úÖ Invalidate and refetch the products query to get fresh data
        queryClient.invalidateQueries({
          queryKey: [...PRODUCTS_QUERY_KEY, brandId]
        });
        
        // ‚úÖ Also invalidate the specific product detail query
        queryClient.invalidateQueries({
          queryKey: [...PRODUCT_DETAIL_QUERY_KEY, productId]
        });
      }
      
      // ‚úÖ Show success toast
      toast.success(`ÏÉÅÌíàÏù¥ ${isActive ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}ÎêòÏóàÏäµÎãàÎã§.`);
      
    } catch (error) {
      console.error('Error toggling product active status:', error);
      
      // ‚úÖ Show specific error messages based on error type
      if (error instanceof TypeError && error.message.includes('fetch')) {
        toast.error('Network connection error - Please check your connection');
      } else if (error instanceof Error) {
        if (error.message.includes('Authentication') || error.message.includes('token')) {
          toast.error('Invalid token - Please login again');
        } else if (error.message.includes('Access denied') || error.message.includes('Í∂åÌïú')) {
          toast.error('Access denied - Contact administrator');
        } else {
          toast.error(`Product status update failed: ${error.message}`);
        }
      } else {
        toast.error('Unknown error occurred');
      }
    } finally {
      // Remove from toggling set
      setTogglingProducts(prev => {
        const newSet = new Set(prev);
        newSet.delete(productId);
        return newSet;
      });
    }
  };

  const handleDeleteProduct = (product: ProductResponseDto) => {
    // Show delete confirmation modal instead of window.confirm
    setProductToDelete(product);
    setShowDeleteModal(true);
  };

  const confirmDeleteProduct = async () => {
    if (!productToDelete) return;
    
    // Add to deleting set for loading state
    setDeletingProducts(prev => new Set(prev).add(productToDelete.id));
    
    try {
      const token = getToken();
      const response = await fetch(`/api/product/${productToDelete.id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      
      if (response.ok && data.success) {
        toast.success('ÏÉÅÌíàÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        
        // ‚úÖ Invalidate products list and product detail caches
        queryClient.invalidateQueries({ queryKey: [...PRODUCTS_QUERY_KEY, brandId] });
        queryClient.invalidateQueries({ queryKey: [...PRODUCT_DETAIL_QUERY_KEY, productToDelete.id] });
        
        // Close modal
        setShowDeleteModal(false);
        setProductToDelete(null);
      } else {
        toast.error(data.message || 'ÏÉÅÌíà ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§');
      }
    } catch (error) {
      console.error('‚ùå Delete product error:', error);
      toast.error('ÏÉÅÌíà ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
    } finally {
      // Remove from deleting set
      setDeletingProducts(prev => {
        const newSet = new Set(prev);
        newSet.delete(productToDelete.id);
        return newSet;
      });
    }
  };

  if (isLoading) {
    return (
      <div className={`bg-white rounded-lg shadow`}>
        <div className="p-6">
          <div className="flex items-center justify-center h-32">
            <div className="text-center">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
              <p className="text-gray-600">ÏÉÅÌíà Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className={`bg-white rounded-lg shadow`}>
        <div className="p-6">
          <div className="flex items-center justify-center h-32">
            <div className="text-center">
              <div className="text-red-500 mb-2">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</div>
              <p className="text-gray-600 text-sm">{error.message}</p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className={`bg-white rounded-lg shadow`}>
      <div className="p-6">

        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                <Input
                  placeholder="ÏÉÅÌíàÎ™Ö, SKU, Ïä¨Îü¨Í∑∏Î°ú Í≤ÄÏÉâ..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 w-64"
                />
              </div>
              <div className="text-sm text-gray-600">
                Ï¥ù <span className="font-semibold text-gray-900">{totalProducts}</span>Í∞ú ÏÉÅÌíà
              </div>
            </div>
            <Button onClick={handleRegisterClick}>ÏÉÅÌíà Îì±Î°ù</Button>
          </div>
          
          {!filteredProducts || filteredProducts.length === 0 ? (
            <div className="border rounded-lg p-8 text-center">
              <p className="text-gray-500">
                {debouncedSearchTerm 
                  ? `"${debouncedSearchTerm}"Ïóê ÎåÄÌïú Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.` 
                  : "Îì±Î°ùÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§."}
              </p>
              {debouncedSearchTerm && (
                <Button 
                  variant="outline" 
                  size="sm" 
                  className="mt-4"
                  onClick={() => setSearchTerm("")}
                >
                  Í≤ÄÏÉâ Ï¥àÍ∏∞Ìôî
                </Button>
              )}
            </div>
          ) : (
            <div className="space-y-0">
              {/* Ìó§Îçî */}
              <div className="flex items-center py-3 px-4 bg-gray-50 rounded-t-lg font-medium text-xs text-gray-600 border-2 border-gray-200">
                <div className="flex-1 text-center border-r border-gray-300 pr-2">ÏÉÅÌíà SKU</div>
                <div className="w-16 text-center border-r border-gray-300 pr-2">Ïù¥ÎØ∏ÏßÄ</div>
                <div className="flex-[2] text-center border-r border-gray-300 pr-2">ÏÉÅÌíàÎ™Ö</div>
                <div className="w-24 text-center border-r border-gray-300 pr-2">ÏÉÅÌÉú</div>
                <div className="w-20 text-center border-r border-gray-300 pr-2">ÌôúÏÑ±</div>
                <div className="w-28 text-center border-r border-gray-300 pr-2">Í∏∞Î≥∏ Í∞ÄÍ≤©</div>
                <div className="w-28 text-center border-r border-gray-300 pr-2">ÎπÑÍµê Í∞ÄÍ≤©</div>
                <div className="w-20 text-center border-r border-gray-300 pr-2">Î≥ÄÌòï Ïàò</div>
                <div className="w-32 text-center pl-2">Ïï°ÏÖò</div>
              </div>
              
              {filteredProducts?.map((product, index) => (
                <div key={product.id} className={`border-l-2 border-r-2 border-b-2 border-gray-200 ${index === filteredProducts.length - 1 ? 'rounded-b-lg' : ''} hover:bg-gray-50 transition-colors cursor-pointer`} onClick={() => handleViewProduct(product)}>
                  <div className="flex items-center py-3 px-4">
                    {/* ÏÉÅÌíà SKU */}
                    <div className="flex-1 text-center border-r border-gray-300 pr-2">
                      <p className="text-xs font-mono text-gray-600 truncate">{product.sku}</p>
                    </div>
                    
                    {/* ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ */}
                    <div className="w-16 flex justify-center border-r border-gray-300 pr-2">
                      <div className="w-10 h-10 bg-gray-100 rounded flex items-center justify-center border border-gray-200">
                        {product.thumbUrl ? (
                          <Image 
                            src={product.thumbUrl} 
                            alt={product.name}
                            className="w-full h-full object-cover rounded"
                            width={40}
                            height={40}
                          />
                        ) : (
                          <div className="text-gray-400 text-xs">-</div>
                        )}
                      </div>
                    </div>
                    
                    {/* ÏÉÅÌíàÎ™Ö */}
                    <div className="flex-[2] text-center min-w-0 border-r border-gray-300 pr-2">
                      <h3 className="font-semibold text-xs truncate">{product.name}</h3>
                    </div>
                    
                    {/* ÏÉÅÌÉú (Status) - READ ONLY */}
                    <div className="w-24 text-center border-r border-gray-300 pr-2">
                      {(() => {
                        const status = product.status;
                        console.log(`üîç Product ${product.name} status:`, status, typeof status);
                        
                        // Handle backend status: pending, approved, rejected, banned
                        if (status === 'approved') {
                          return (
                            <Badge variant="secondary" className="bg-purple-100 text-purple-800 text-xs">
                              ÏäπÏù∏ÏôÑÎ£å
                            </Badge>
                          );
                        }
                        if (status === 'pending') {
                          return (
                            <Badge variant="outline" className="text-orange-600 border-orange-300 text-xs">
                              ÎåÄÍ∏∞Ï§ë
                            </Badge>
                          );
                        }
                        if (status === 'rejected') {
                          return (
                            <Badge variant="destructive" className="text-xs">
                              Í±∞Î∂ÄÎê®
                            </Badge>
                          );
                        }
                        if (status === 'banned') {
                          return (
                            <Badge variant="destructive" className="bg-red-100 text-red-800 border-red-300 text-xs">
                              Ï∞®Îã®Îê®
                            </Badge>
                          );
                        }
                        
                        // Show actual status value if it exists but doesn't match expected values
                        if (status && status !== '') {
                          return (
                            <Badge variant="outline" className="text-blue-600 border-blue-300 text-xs">
                              {String(status)}
                            </Badge>
                          );
                        }
                        
                        // Default case - no status
                        return (
                          <Badge variant="outline" className="text-gray-500 text-xs">
                            -
                          </Badge>
                        );
                      })()}
                    </div>
                    
                    {/* ÌôúÏÑ± (Active) - EDITABLE */}
                    <div className="w-20 text-center border-r border-gray-300 pr-2" onClick={(e) => e.stopPropagation()}>
                      <Switch
                        checked={product.isActive ?? true}
                        onCheckedChange={(checked) => handleToggleActive(product.id, checked)}
                        disabled={togglingProducts.has(product.id)}
                      />
                    </div>
                    
                    {/* Í∏∞Î≥∏ Í∞ÄÍ≤© */}
                    <div className="w-28 text-center border-r border-gray-300 pr-2">
                      <p className="text-xs font-medium">{product.basePrice.toLocaleString()}Ïõê</p>
                    </div>
                    
                    {/* ÎπÑÍµê Í∞ÄÍ≤© */}
                    <div className="w-28 text-center border-r border-gray-300 pr-2">
                      {product.baseCompareAtPrice ? (
                        <p className="text-xs text-gray-400 line-through">
                          {product.baseCompareAtPrice.toLocaleString()}Ïõê
                        </p>
                      ) : (
                        <p className="text-xs text-gray-400">-</p>
                      )}
                    </div>
                    
                    {/* Î≥ÄÌòï Ïàò */}
                    <div className="w-20 text-center border-r border-gray-300 pr-2">
                      <p className="text-xs">{product.variants?.length || 0}Í∞ú</p>
                    </div>
                    
                    {/* Ïï°ÏÖò Î≤ÑÌäº */}
                    <div className="w-32 flex justify-center gap-1 pl-2" onClick={(e) => e.stopPropagation()}>
                      <Button 
                        size="sm" 
                        variant="outline" 
                        className="text-xs px-2 py-1 h-6"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleEditProduct(product);
                        }}
                      >
                        Ìé∏Ïßë
                      </Button>
                      <Button 
                        size="sm" 
                        variant="outline" 
                        className="text-xs px-2 py-1 h-6"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleDeleteProduct(product);
                        }}
                        disabled={deletingProducts.has(product.id)}
                      >
                        {deletingProducts.has(product.id) ? 'ÏÇ≠Ï†ú Ï§ë...' : 'ÏÇ≠Ï†ú'}
                      </Button>
                      <Button size="sm" variant="outline" className="text-xs px-2 py-1 h-6">
                        Î≥µÏÇ¨
                      </Button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          {/* Pagination - Always show */}
          <div className="flex justify-center mt-6 border-t pt-4">
            <div className="flex items-center gap-4">
              <Button 
                variant="outline" 
                size="sm"
                onClick={() => {
                  console.log('‚¨ÖÔ∏è Prev clicked, current page:', pageNumber);
                  setPageNumber(prev => {
                    const newPage = Math.max(1, prev - 1);
                    console.log('‚¨ÖÔ∏è New page:', newPage);
                    return newPage;
                  });
                }}
                disabled={pageNumber === 1}
              >
                Ïù¥Ï†Ñ
              </Button>
              <div className="flex items-center gap-2 text-sm">
                <span className="text-gray-600">ÌéòÏù¥ÏßÄ</span>
                <span className="font-semibold text-gray-900">{pageNumber}</span>
                <span className="text-gray-600">/</span>
                <span className="font-semibold text-gray-900">{totalPages}</span>
              </div>
              <Button 
                variant="outline" 
                size="sm"
                onClick={() => {
                  console.log('‚û°Ô∏è Next clicked, current page:', pageNumber);
                  setPageNumber(prev => {
                    const newPage = Math.min(totalPages, prev + 1);
                    console.log('‚û°Ô∏è New page:', newPage);
                    return newPage;
                  });
                }}
                disabled={pageNumber === totalPages}
              >
                Îã§Ïùå
              </Button>
            </div>
          </div>
        </div>
      </div>

      {/* Product Delete Confirmation Modal */}
      <ProductDeleteConfirmModal
        product={productToDelete}
        open={showDeleteModal}
        onOpenChange={setShowDeleteModal}
        onConfirm={confirmDeleteProduct}
        isDeleting={productToDelete ? deletingProducts.has(productToDelete.id) : false}
      />

      {/* Product Detail Modal */}
      <Dialog open={showDetailModal} onOpenChange={setShowDetailModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>ÏÉÅÌíà ÏÉÅÏÑ∏ Ï†ïÎ≥¥</DialogTitle>
          </DialogHeader>
          
          {selectedProduct && (
            <div className="space-y-6">
              {/* Basic Info */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Image
                    src={selectedProduct.thumbUrl || selectedProduct.images?.[0] || "/logo.png"}
                    alt={selectedProduct.name}
                    width={400}
                    height={400}
                    className="rounded-lg border w-full h-auto object-cover"
                  />
                </div>
                <div className="space-y-3">
                  <div>
                    <p className="text-sm text-gray-500">ÏÉÅÌíàÎ™Ö</p>
                    <p className="font-semibold text-lg">{selectedProduct.name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">SKU</p>
                    <p>{selectedProduct.sku || '-'}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">Í∏∞Î≥∏ Í∞ÄÍ≤©</p>
                    <p className="text-xl font-bold">{selectedProduct.basePrice?.toLocaleString()}Ïõê</p>
                  </div>
                  {selectedProduct.baseCompareAtPrice && selectedProduct.baseCompareAtPrice > 0 && (
                    <div>
                      <p className="text-sm text-gray-500">ÎπÑÍµê Í∞ÄÍ≤©</p>
                      <p className="text-gray-400 line-through">{selectedProduct.baseCompareAtPrice.toLocaleString()}Ïõê</p>
                    </div>
                  )}
                  <div>
                    <p className="text-sm text-gray-500">ÏÉÅÌÉú</p>
                    <Badge variant={selectedProduct.isActive ? "default" : "secondary"}>
                      {selectedProduct.isActive ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±'}
                    </Badge>
                  </div>
                  {selectedProduct.quantity !== null && selectedProduct.quantity !== undefined && (
                    <div>
                      <p className="text-sm text-gray-500">ÏÉÅÌíà Ïû¨Í≥†</p>
                      <p>{selectedProduct.quantity === null ? 'Î¨¥Ï†úÌïú' : `${selectedProduct.quantity}Í∞ú`}</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Description */}
              {selectedProduct.description && (
                <div>
                  <p className="text-sm text-gray-500 mb-2">ÏÉÅÌíà ÏÑ§Î™Ö</p>
                  <p className="text-gray-700 whitespace-pre-wrap">{selectedProduct.description}</p>
                </div>
              )}

              {/* Variants */}
              {selectedProduct.variants && selectedProduct.variants.length > 0 && (
                <div>
                  <p className="text-sm text-gray-500 mb-3">Î≥ÄÌòï ÏòµÏÖò ({selectedProduct.variants.length}Í∞ú)</p>
                  <div className="space-y-2">
                    {selectedProduct.variants.map((variant, index) => {
                      let optionsDisplay = '-';
                      try {
                        if (variant.optionsJson) {
                          const options = JSON.parse(variant.optionsJson);
                          optionsDisplay = options.map((opt: Record<string, string>) => 
                            Object.entries(opt).map(([key, value]) => `${key}: ${value}`).join(', ')
                          ).join(' / ');
                        }
                      } catch (e) {
                        console.error('Failed to parse options:', e);
                      }

                      return (
                        <div key={variant.id || index} className="border rounded-lg p-3 bg-gray-50">
                          <div className="grid grid-cols-4 gap-3 text-sm">
                            <div>
                              <p className="text-gray-500">ÏòµÏÖò</p>
                              <p className="font-medium">{optionsDisplay}</p>
                            </div>
                            <div>
                              <p className="text-gray-500">Í∞ÄÍ≤©</p>
                              <p className="font-medium">{variant.price?.toLocaleString()}Ïõê</p>
                            </div>
                            <div>
                              <p className="text-gray-500">Ïû¨Í≥†</p>
                              <p className="font-medium">{variant.quantity}Í∞ú</p>
                            </div>
                            <div>
                              <p className="text-gray-500">ÏÉÅÌÉú</p>
                              <Badge variant={variant.status === 'active' ? 'default' : 'secondary'} className="text-xs">
                                {variant.status === 'active' ? 'ÌôúÏÑ±' : variant.status === 'paused' ? 'ÏùºÏãúÏ†ïÏßÄ' : 'Î≥¥Í¥Ä'}
                              </Badge>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* Images */}
              {selectedProduct.images && selectedProduct.images.length > 0 && (
                <div>
                  <p className="text-sm text-gray-500 mb-3">ÏÉÅÏÑ∏ Ïù¥ÎØ∏ÏßÄ ({selectedProduct.images.length}Í∞ú)</p>
                  <div className="grid grid-cols-4 gap-2">
                    {selectedProduct.images.map((image, index) => (
                      <Image
                        key={index}
                        src={image}
                        alt={`${selectedProduct.name} ${index + 1}`}
                        width={150}
                        height={150}
                        className="rounded border w-full h-auto object-cover"
                      />
                    ))}
                  </div>
                </div>
              )}

              {/* Action Buttons */}
              <div className="flex gap-3 justify-end pt-4 border-t">
                <Button variant="outline" onClick={() => setShowDetailModal(false)}>
                  Îã´Í∏∞
                </Button>
                <Button onClick={() => {
                  setShowDetailModal(false);
                  handleEditProduct(selectedProduct);
                }}>
                  Ìé∏ÏßëÌïòÍ∏∞
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}
